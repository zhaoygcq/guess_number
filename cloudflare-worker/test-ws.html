<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Test - Cloudflare Worker</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
    #status { padding: 10px; border-radius: 4px; margin: 10px 0; font-weight: bold; }
    .connected { background: #d4edda; color: #155724; }
    .disconnected { background: #f8d7da; color: #721c24; }
    .connecting { background: #fff3cd; color: #856404; }
    #log { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f5f5f5; font-family: monospace; font-size: 12px; }
    .log-entry { margin: 4px 0; padding: 2px 0; border-bottom: 1px solid #e0e0e0; }
    .log-error { color: #d32f2f; }
    .log-success { color: #388e3c; }
    .log-info { color: #1976d2; }
    .log-warn { color: #f57c00; }
    button { padding: 8px 16px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; font-size: 14px; }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    button.disconnect { background: #dc3545; }
    button.disconnect:hover { background: #c82333; }
    input { padding: 8px; width: 280px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; font-size: 14px; }
    .section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background: #fafafa; }
    h1 { color: #333; }
    h2 { color: #555; font-size: 18px; margin-top: 0; }
  </style>
</head>
<body>
  <h1>ğŸ® Guess Number Relay WebSocket æµ‹è¯•</h1>

  <div class="section">
    <h2>è¿æ¥çŠ¶æ€</h2>
    <div id="status" class="disconnected">æœªè¿æ¥</div>
    <div>
      <input type="text" id="url" value="wss://guess-number-relay.1060401583.workers.dev" placeholder="wss://...">
      <button onclick="connect()">è¿æ¥</button>
      <button onclick="disconnect()" class="disconnect">æ–­å¼€</button>
    </div>
  </div>

  <div class="section">
    <h2>å‘é€æ¶ˆæ¯</h2>
    <div>
      <input type="text" id="roomId" value="room123" placeholder="æˆ¿é—´å·">
      <button onclick="sendJoin()">åŠ å…¥æˆ¿é—´</button>
      <button onclick="sendSignal()">å‘é€ä¿¡ä»¤</button>
    </div>
    <div style="margin-top: 10px;">
      <input type="text" id="customMsg" placeholder='{"type":"...","..."}'>
      <button onclick="sendCustom()">å‘é€è‡ªå®šä¹‰æ¶ˆæ¯</button>
    </div>
  </div>

  <div class="section">
    <h2>æ—¥å¿—</h2>
    <div id="log"></div>
  </div>

  <script>
    let ws = null;

    function connect() {
      const url = document.getElementById('url').value;

      if (ws) {
        ws.close();
        ws = null;
      }

      log(`æ­£åœ¨è¿æ¥: ${url}`, 'info');
      updateStatus('connecting', 'è¿æ¥ä¸­...');

      try {
        ws = new WebSocket(url);

        ws.onopen = function() {
          log('âœ… WebSocket è¿æ¥æˆåŠŸ!', 'success');
          updateStatus('connected', 'å·²è¿æ¥');
        };

        ws.onmessage = function(event) {
          log(`ğŸ“¨ æ”¶åˆ°: ${event.data}`, 'info');
          try {
            const data = JSON.parse(event.data);
            log(`è§£ææ•°æ®: ${JSON.stringify(data, null, 2)}`, 'info');
          } catch (e) {
            // ä¸æ˜¯ JSON
          }
        };

        ws.onclose = function(event) {
          log(`âŒ è¿æ¥å…³é—­ (code: ${event.code}, reason: ${event.reason || 'æ— '})`, 'error');
          updateStatus('disconnected', 'å·²æ–­å¼€');
          ws = null;
        };

        ws.onerror = function(error) {
          log(`âŒ é”™è¯¯: ${error}`, 'error');
          updateStatus('disconnected', 'é”™è¯¯');
        };
      } catch (e) {
        log(`âŒ è¿æ¥å¤±è´¥: ${e.message}`, 'error');
        updateStatus('disconnected', 'å¤±è´¥');
      }
    }

    function disconnect() {
      if (ws) {
        ws.close();
        ws = null;
        log('ä¸»åŠ¨æ–­å¼€è¿æ¥', 'warn');
      }
    }

    function sendJoin() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('âŒ æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯', 'error');
        return;
      }

      const roomId = document.getElementById('roomId').value || 'room123';
      const joinMsg = JSON.stringify({
        type: 'JOIN',
        roomId: roomId
      });

      ws.send(joinMsg);
      log(`ğŸ“¤ å‘é€åŠ å…¥æˆ¿é—´: ${joinMsg}`, 'info');
    }

    function sendSignal() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('âŒ æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯', 'error');
        return;
      }

      const signalMsg = JSON.stringify({
        type: 'SIGNAL',
        data: { test: 'hello from client' }
      });

      ws.send(signalMsg);
      log(`ğŸ“¤ å‘é€ä¿¡ä»¤: ${signalMsg}`, 'info');
    }

    function sendCustom() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('âŒ æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯', 'error');
        return;
      }

      const customMsg = document.getElementById('customMsg').value;
      if (!customMsg) {
        log('âŒ è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'error');
        return;
      }

      try {
        // éªŒè¯ JSON
        JSON.parse(customMsg);
        ws.send(customMsg);
        log(`ğŸ“¤ å‘é€è‡ªå®šä¹‰: ${customMsg}`, 'info');
      } catch (e) {
        log('âŒ æ¶ˆæ¯å¿…é¡»æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼', 'error');
      }
    }

    function updateStatus(state, text) {
      const status = document.getElementById('status');
      status.textContent = text;
      status.className = state;
    }

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // é¡µé¢åŠ è½½æ—¶è¾“å‡ºå¸®åŠ©ä¿¡æ¯
    log('=== WebSocket æµ‹è¯•å·¥å…· ===', 'info');
    log('1. ç‚¹å‡»"è¿æ¥"æŒ‰é’®æµ‹è¯• WebSocket', 'info');
    log('2. è¿æ¥æˆåŠŸåç‚¹å‡»"åŠ å…¥æˆ¿é—´"åŠ å…¥æµ‹è¯•æˆ¿é—´', 'info');
    log('3. è§‚å¯Ÿæ—¥å¿—è¾“å‡º', 'info');
    log('', 'info');
  </script>
</body>
</html>
