<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebSocket Test - Guess Number Relay</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
    #status { padding: 10px; border-radius: 4px; margin: 10px 0; }
    .connected { background: #d4edda; color: #155724; }
    .disconnected { background: #f8d7da; color: #721c24; }
    #log { height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: #f5f5f5; font-family: monospace; font-size: 12px; }
    .log-entry { margin: 4px 0; }
    .log-error { color: red; }
    .log-success { color: green; }
    .log-info { color: blue; }
    button { padding: 8px 16px; margin: 5px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 4px; }
    button:hover { background: #0056b3; }
    button:disabled { background: #ccc; cursor: not-allowed; }
    button.disconnect { background: #dc3545; }
    button.disconnect:hover { background: #c82333; }
    input { padding: 8px; width: 200px; margin: 5px; border: 1px solid #ccc; border-radius: 4px; }
  </style>
</head>
<body>
  <h1>ğŸ® Guess Number Relay WebSocket æµ‹è¯•</h1>

  <div id="status" class="disconnected">è¿æ¥çŠ¶æ€: æœªè¿æ¥</div>

  <div style="margin: 10px 0;">
    <input type="text" id="url" value="ws://localhost:8787" placeholder="ws://localhost:8787">
    <button onclick="connect()">è¿æ¥</button>
    <button onclick="disconnect()" class="disconnect">æ–­å¼€</button>
  </div>

  <div style="margin: 10px 0;">
    <input type="text" id="message" placeholder="è¾“å…¥æ¶ˆæ¯ (JSONæ ¼å¼)">
    <button onclick="sendMessage()">å‘é€æ¶ˆæ¯</button>
    <button onclick="sendJoin()">åŠ å…¥æˆ¿é—´</button>
  </div>

  <div id="log"></div>

  <script>
    let ws = null;

    function connect() {
      const url = document.getElementById('url').value;

      if (ws) {
        ws.close();
        ws = null;
      }

      log(`æ­£åœ¨è¿æ¥: ${url}`, 'info');

      try {
        ws = new WebSocket(url);

        ws.onopen = function() {
          log('âœ… è¿æ¥æˆåŠŸ!', 'success');
          document.getElementById('status').textContent = 'è¿æ¥çŠ¶æ€: å·²è¿æ¥';
          document.getElementById('status').className = 'connected';
        };

        ws.onmessage = function(event) {
          log(`ğŸ“¨ æ”¶åˆ°: ${event.data}`, 'info');
          try {
            const data = JSON.parse(event.data);
            log(`è§£ææ•°æ®: ${JSON.stringify(data)}`, 'info');
          } catch (e) {
            // ä¸æ˜¯ JSON
          }
        };

        ws.onclose = function(event) {
          log(`âŒ è¿æ¥å…³é—­ (code: ${event.code})`, 'error');
          document.getElementById('status').textContent = 'è¿æ¥çŠ¶æ€: å·²æ–­å¼€';
          document.getElementById('status').className = 'disconnected';
          ws = null;
        };

        ws.onerror = function(error) {
          log(`âŒ é”™è¯¯: ${error}`, 'error');
        };
      } catch (e) {
        log(`âŒ è¿æ¥å¤±è´¥: ${e.message}`, 'error');
      }
    }

    function disconnect() {
      if (ws) {
        ws.close();
        ws = null;
        log('ä¸»åŠ¨æ–­å¼€è¿æ¥', 'info');
      }
    }

    function sendMessage() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('âŒ æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯', 'error');
        return;
      }

      const msg = document.getElementById('message').value;
      if (!msg) {
        log('âŒ è¯·è¾“å…¥æ¶ˆæ¯å†…å®¹', 'error');
        return;
      }

      try {
        // å¦‚æœè¾“å…¥çš„ä¸æ˜¯ JSONï¼ŒåŒ…è£¹æˆ JSON
        let data = msg;
        try {
          JSON.parse(msg);
        } catch (e) {
          data = JSON.stringify({ type: 'message', data: msg });
        }

        ws.send(data);
        log(`ğŸ“¤ å‘é€: ${data}`, 'info');
      } catch (e) {
        log(`âŒ å‘é€å¤±è´¥: ${e.message}`, 'error');
      }
    }

    function sendJoin() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        log('âŒ æœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯', 'error');
        return;
      }

      const joinMsg = JSON.stringify({
        type: 'JOIN',
        roomId: 'test123'
      });

      ws.send(joinMsg);
      log(`ğŸ“¤ å‘é€åŠ å…¥æˆ¿é—´: ${joinMsg}`, 'info');
    }

    function log(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = `log-entry log-${type}`;
      entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logDiv.appendChild(entry);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    // é¡µé¢åŠ è½½æ—¶è¾“å‡ºå¸®åŠ©ä¿¡æ¯
    log('è¯·å…ˆç¡®è®¤ wrangler dev æ­£åœ¨è¿è¡Œ', 'info');
    log('é»˜è®¤è¿æ¥åœ°å€: ws://localhost:8787', 'info');
    log('å¦‚æœæ˜¯ HTTPS é¡µé¢ï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ wrangler dev --local-https', 'info');
  </script>
</body>
</html>
